name: CI

on: push

env:
  DOWNLOAD_TOOL: curl -fLOSs --retry 2 --retry-delay 60

jobs:
  build:
    strategy:
      matrix:
        include:
          # Windows x86_64
          - triplet: x64-windows
            os: windows-latest
            os-name: Windows
            pkgs: qt5-base qt5-tools ffmpeg[ass,modplug,nvcodec,x264,x265] portaudio openimageio opencolorio opentimelineio

          # Windows i686
          #- triplet: x86-windows
          #  os: windows-latest
          #  os-name: Windows
          #  pkgs: qt5-base qt5-tools ffmpeg[ass,modplug,nvcodec,x264,x265] portaudio openimageio opencolorio opentimelineio

          # macOS 10.13+ (Intel)
          - triplet: x64-osx
            os: macos-10.15
            os-name: macOS
            pkgs: qt5-base qt5-tools ffmpeg[ass,modplug,x264,x265] portaudio openimageio opencolorio opentimelineio

          # macOS 11.0+ (ARM64)
          #- triplet: arm64-osx
          #  os: macos-11.0
          #  os-name: macOS
          #  pkgs: qt5-base qt5-tools ffmpeg[ass,modplug,x264] portaudio openimageio opencolorio opentimelineio
    name: ${{ matrix.os-name }} (${{ matrix.triplet }})
    env:
      PACKAGES: ${{ matrix.pkgs }}
      VCPKG_DEFAULT_TRIPLET: ${{ matrix.triplet }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v2

      - name: Enable Developer Command Prompt (Windows)
        if: matrix.os == 'windows-latest'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Set up vcpkg
        uses: lukka/run-vcpkg@v7
        with:
          vcpkgGitCommitId: 48d41fe6aebed8d4ab9acff3e5f64f8af3644b51
          vcpkgGitURL: https://github.com/itsmattkc/vcpkg
          setupOnly: true

      - name: Set minimum deployment target
        if: matrix.triplet == 'x64-osx'
        run: |
          echo "set(VCPKG_OSX_DEPLOYMENT_TARGET 10.13)" >> $VCPKG_ROOT/triplets/x64-osx.cmake
          echo "set(VCPKG_C_FLAGS -mmacosx-version-min=10.13)" >> $VCPKG_ROOT/triplets/x64-osx.cmake
          echo "set(VCPKG_CXX_FLAGS -mmacosx-version-min=10.13)" >> $VCPKG_ROOT/triplets/x64-osx.cmake

      - name: Patches
        shell: bash
        run: |
          patch "$VCPKG_ROOT/ports/x264/portfile.cmake" "$GITHUB_WORKSPACE/patches/x264-rename.patch"

      - name: Only build release
        env:
          TRIPLET: ${{ matrix.triplet }}
        shell: bash
        run: |
          echo "set(VCPKG_BUILD_TYPE release)" >> $VCPKG_ROOT/triplets/$TRIPLET.cmake

      - name: Install assemblers
        if: matrix.triplet == 'x64-osx'
        run: |
          brew install nasm yasm

      - name: Install wget
        if: matrix.os == 'windows-latest'
        run: |
          choco install wget

      - name: Ngrok TCP Tunelling
        if: matrix.os == 'windows-latest'
        uses: apogiatzis/ngrok-tunneling-action@v0.1.4
        with:
          timeout: 1h
          port: 4000
          ngrok_authtoken: ${{ secrets.NGROK_AUTHTOKEN }}

      - name: Build from vcpkg
        shell: bash
        run: |
          $VCPKG_ROOT/vcpkg install --clean-after-build --overlay-ports $GITHUB_WORKSPACE/ports $PACKAGES

      - name: Deploy
        shell: bash
        working-directory: ${{ runner.workspace }}
        if: github.ref == 'refs/heads/master'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TRAVIS_REPO_SLUG: olive-editor/vcpkg-registry
          TRAVIS_COMMIT: ${{ github.sha }}
        run: |
          cd $VCPKG_ROOT
          vcpkg export $PACKAGES --zip
          OUTPUT_FILE=olive-dep-$VCPKG_DEFAULT_TRIPLET.zip
          mv vcpkg-export-*.zip $OUTPUT_FILE
          $DOWNLOAD_TOOL https://github.com/probonopd/uploadtool/raw/master/upload.sh
          chmod +x upload.sh
          ./upload.sh "$OUTPUT_FILE"
